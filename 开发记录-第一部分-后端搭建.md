# AIè§’è‰²æ‰®æ¼”ç½‘é¡µé¡¹ç›®å¼€å‘è®°å½•ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°
æœ¬æ–‡æ¡£è®°å½•äº†AIè§’è‰²æ‰®æ¼”ç½‘é¡µé¡¹ç›®ä»é›¶å¼€å§‹æ­å»ºçš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç¯å¢ƒæ£€æŸ¥ã€é¡¹ç›®ç»“æ„åˆ›å»ºã€åç«¯æ¡†æ¶æ­å»ºçš„æ‰€æœ‰ç»†èŠ‚ã€‚

---

## ğŸ” ç¬¬ä¸€é˜¶æ®µï¼šå¼€å‘ç¯å¢ƒæ£€æŸ¥ä¸éªŒè¯

### 1.1 æ‰§è¡Œçš„æ£€æŸ¥å‘½ä»¤åŠç»“æœ
```powershell
node --version    # ç»“æœï¼šv22.16.0
python --version  # ç»“æœï¼šPython 3.10.7  
git --version     # ç»“æœï¼šgit version 2.50.0.windows.1
npm --version     # ç»“æœï¼š11.5.2
pip --version     # ç»“æœï¼špip 25.2
```

### 1.2 æ£€æŸ¥åŸå› ä¸å¿…è¦æ€§
- **Node.js v22.16.0**: æ”¯æŒReact 18å’ŒVite 5çš„æœ€æ–°ç‰¹æ€§
- **Python 3.10.7**: å…¼å®¹FastAPIå¼‚æ­¥ç‰¹æ€§å’ŒOpenAI SDK
- **Git 2.50.0**: ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œæ”¯æŒç°ä»£å¼€å‘æµç¨‹
- **npm/pip**: åŒ…ç®¡ç†å™¨ï¼Œç”¨äºå®‰è£…å‰åç«¯ä¾èµ–

---

## ğŸ—ï¸ ç¬¬äºŒé˜¶æ®µï¼šé¡¹ç›®é…ç½®æ–‡ä»¶åˆ›å»ºä¸å®Œå–„

### 2.1 åç«¯ä¾èµ–é…ç½®å‡çº§

**æŸ¥çœ‹æ–‡ä»¶ï¼š** `backend/requirements.txt`

**åŸå§‹å†…å®¹ï¼š**
```
fastapi==0.111.0
uvicorn[standard]==0.30.1
python-dotenv==1.0.1
pydantic==2.7.1
pydantic-settings==2.2.1
openai==1.30.1
```

**å®Œå–„åå†…å®¹ï¼š**
```
fastapi==0.111.0
uvicorn[standard]==0.30.1
python-dotenv==1.0.1
pydantic==2.7.1
pydantic-settings==2.2.1
openai==1.30.1
websockets==12.0          # æ–°å¢ï¼šWebSocketå®æ—¶é€šä¿¡
psycopg2-binary==2.9.9    # æ–°å¢ï¼šPostgreSQLæ•°æ®åº“é©±åŠ¨
redis==5.0.4              # æ–°å¢ï¼šRedisç¼“å­˜æ”¯æŒ
python-multipart==0.0.9   # æ–°å¢ï¼šæ–‡ä»¶ä¸Šä¼ æ”¯æŒï¼ˆè¯­éŸ³ï¼‰
cors==1.0.1               # æ–°å¢ï¼šè·¨åŸŸæ”¯æŒ
fastapi-cors==0.0.6       # æ–°å¢ï¼šFastAPI CORSä¸­é—´ä»¶
```

**æ–°å¢ä¾èµ–çš„åŸå› ï¼š**
- **websockets**: æ”¯æŒè¯­éŸ³èŠå¤©çš„å®æ—¶WebSocketè¿æ¥
- **psycopg2-binary**: æœªæ¥æ•°æ®æŒä¹…åŒ–éœ€æ±‚
- **redis**: ä¼šè¯ç®¡ç†å’Œç¼“å­˜
- **python-multipart**: è¯­éŸ³æ–‡ä»¶ä¸Šä¼ å¤„ç†
- **corsç›¸å…³**: è§£å†³å‰åç«¯è·¨åŸŸé—®é¢˜

### 2.2 å‰ç«¯package.jsonåˆ›å»º

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/package.json`

**åŸå§‹çŠ¶æ€ï¼š** å®Œå…¨ç©ºæ–‡ä»¶

**åˆ›å»ºå†…å®¹ï¼š**
```json
{
  "name": "ai-roleplay-frontend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build", 
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",       # Reactæ ¸å¿ƒåº“
    "react-dom": "^18.3.1",   # React DOMæ¸²æŸ“
    "zustand": "^4.5.2",      # çŠ¶æ€ç®¡ç†
    "axios": "^1.7.2"         # HTTPè¯·æ±‚åº“
  },
  "devDependencies": {
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",  # CSSæ¡†æ¶
    "vite": "^5.3.1"          # æ„å»ºå·¥å…·
  }
}
```

### 2.3 æ„å»ºé…ç½®æ–‡ä»¶åˆ›å»º

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/vite.config.js`
```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,     # å‰ç«¯å¼€å‘æœåŠ¡å™¨ç«¯å£
    host: true      # å…è®¸å¤–éƒ¨è®¿é—®
  }
})
```

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/tailwind.config.js`
```javascript
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",  # æ‰«ææ‰€æœ‰Reactæ–‡ä»¶
  ],
  theme: { extend: {} },
  plugins: [],
}
```

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/postcss.config.js`
```javascript
export default {
  plugins: {
    tailwindcss: {},    # Tailwind CSSå¤„ç†
    autoprefixer: {},   # è‡ªåŠ¨æ·»åŠ CSSå‰ç¼€
  },
}
```

### 2.4 HTMLå’ŒCSSåŸºç¡€æ–‡ä»¶

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/index.html`
```html
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIè§’è‰²æ‰®æ¼”èŠå¤©</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
```

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/src/index.css`
```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer components {
  .btn-primary {
    @apply bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors;
  }
  .chat-bubble-user {
    @apply bg-blue-500 text-white rounded-lg px-4 py-2 max-w-xs ml-auto;
  }
  .chat-bubble-ai {
    @apply bg-gray-200 text-gray-800 rounded-lg px-4 py-2 max-w-xs mr-auto;
  }
}
```

**åˆ›å»ºæ–‡ä»¶ï¼š** `frontend/src/main.jsx`
```javascript
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
```

---

## âš™ï¸ ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯æ¡†æ¶æ ¸å¿ƒé—®é¢˜ä¿®å¤

### 3.1 é…ç½®ç³»ç»Ÿé‡å¤§é—®é¢˜è§£å†³

**æŸ¥çœ‹æ–‡ä»¶ï¼š** `backend/app/core/config.py`

**é‡åˆ°çš„å…³é”®é”™è¯¯ï¼š**
```
ValidationError: 7 validation errors for Settings
database_url: Extra inputs are not permitted [type=extra_forbidden]
redis_url: Extra inputs are not permitted [type=extra_forbidden]
debug: Extra inputs are not permitted [type=extra_forbidden]
secret_key: Extra inputs are not permitted [type=extra_forbidden]
cors_origins: Extra inputs are not permitted [type=extra_forbidden]
api_host: Extra inputs are not permitted [type=extra_forbidden]  
api_port: Extra inputs are not permitted [type=extra_forbidden]
```

**é—®é¢˜æ ¹æºï¼š**
æ ¹æ®è®°å¿†ä¸­çš„ç»éªŒï¼ˆPydanticé…ç½®æ¨¡å‹å­—æ®µéªŒè¯ï¼‰ï¼Œ.envæ–‡ä»¶ä¸­çš„é…ç½®é¡¹å¿…é¡»åœ¨Settingsæ¨¡å‹ç±»ä¸­æ˜ç¡®å®šä¹‰å¯¹åº”å­—æ®µï¼Œå¦åˆ™ä¼šå› extra='forbid'ç­–ç•¥å¯¼è‡´ValidationErrorã€‚

**è§£å†³æ–¹æ¡ˆ - å®Œå…¨é‡å†™é…ç½®ç±»ï¼š**
```python
from pydantic_settings import BaseSettings
import os
from typing import Optional, List
import json

class Settings(BaseSettings):
    """å…¨å±€é…ç½®ç±»ï¼šä».envåŠ è½½é…ç½®ï¼Œæ— åˆ™ä½¿ç”¨é»˜è®¤å€¼"""
    # OpenAIé…ç½®
    OPENAI_API_KEY: Optional[str] = None
    LLM_MODEL_NAME: str = "gpt-4o"
    TTS_MODEL_NAME: str = "tts-1"
    ASR_MODEL_NAME: str = "whisper-1"

    # æ•°æ®åº“é…ç½® - æ–°å¢
    DATABASE_URL: Optional[str] = None
    
    # Redisé…ç½® - æ–°å¢
    REDIS_URL: Optional[str] = None
    
    # åº”ç”¨é…ç½® - æ–°å¢
    DEBUG: bool = True
    SECRET_KEY: str = "default-secret-key"
    CORS_ORIGINS: str = '["http://localhost:3000"]'
    
    # APIé…ç½® - æ–°å¢
    API_HOST: str = "0.0.0.0"
    API_PORT: int = 8000

    # æœåŠ¡é…ç½®
    API_PREFIX: str = "/api"
    WS_PREFIX: str = "/ws"
    MAX_CONVERSATION_HISTORY: int = 20
    
    @property
    def cors_origins_list(self) -> List[str]:
        """å°†CORS_ORIGINSå­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨"""
        try:
            return json.loads(self.CORS_ORIGINS)
        except:
            return ["http://localhost:3000"]

    class Config:
        env_file = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), ".env")
        env_file_encoding = "utf-8"
        extra = 'allow'  # å…³é”®ä¿®æ”¹ï¼šå…è®¸é¢å¤–å­—æ®µ
```

**ä¿®æ”¹çš„å…³é”®åŸå› ï¼š**
1. **æ·»åŠ æ‰€æœ‰ç¼ºå¤±å­—æ®µ**ï¼šDATABASE_URLã€REDIS_URLã€DEBUGç­‰
2. **è®¾ç½®extra='allow'**ï¼šå…è®¸.envæ–‡ä»¶ä¸­çš„é¢å¤–é…ç½®é¡¹
3. **æ·»åŠ JSONè§£ææ–¹æ³•**ï¼šå¤„ç†CORS_ORIGINSçš„å­—ç¬¦ä¸²åˆ°åˆ—è¡¨è½¬æ¢
4. **ç¡®ä¿å‘åå…¼å®¹**ï¼šä¿æŒæ‰€æœ‰åŸæœ‰é…ç½®é¡¹

### 3.2 ç¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»º

**åˆ›å»ºæ–‡ä»¶ï¼š** `backend/.env`
```bash
# OpenAI APIé…ç½®ï¼ˆæµ‹è¯•ç”¨å ä½ç¬¦ï¼‰
OPENAI_API_KEY=sk-test-placeholder-key

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///./test.db

# Redisé…ç½®
REDIS_URL=redis://localhost:6379/0

# åº”ç”¨é…ç½®
DEBUG=True
SECRET_KEY=test-secret-key-change-in-production
CORS_ORIGINS=["http://localhost:3000"]

# APIé…ç½®
API_HOST=0.0.0.0
API_PORT=8000
```

**åˆ›å»ºåŸå› ï¼š**
ä¸ºMVPå¼€å‘é˜¶æ®µæä¾›åŸºç¡€é…ç½®ï¼Œä½¿ç”¨æµ‹è¯•å¯†é’¥é¿å…çœŸå®APIè°ƒç”¨äº§ç”Ÿè´¹ç”¨ã€‚

---

## ğŸ”§ ç¬¬å››é˜¶æ®µï¼šåç«¯æœåŠ¡é€»è¾‘ä¿®å¤

### 4.1 LLMå®¢æˆ·ç«¯å½»åº•é‡æ„

**æŸ¥çœ‹æ–‡ä»¶ï¼š** `backend/app/core/llm_client.py`

**åŸå§‹é—®é¢˜ï¼š**
1. OpenAIå®¢æˆ·ç«¯åˆå§‹åŒ–å¼ºåˆ¶è¦æ±‚APIå¯†é’¥
2. æ²¡æœ‰å¼€å‘é˜¶æ®µçš„æ¨¡æ‹Ÿæ¨¡å¼
3. ç¼ºå°‘é”™è¯¯å®¹é”™å¤„ç†

**å®Œå…¨é‡å†™çš„æ ¸å¿ƒé€»è¾‘ï¼š**
```python
class LLMClient:
    def __init__(self):
        # å…³é”®æ”¹è¿›ï¼šæ¡ä»¶åˆå§‹åŒ–
        self.client = None
        if settings.OPENAI_API_KEY and settings.OPENAI_API_KEY != "sk-test-placeholder-key":
            try:
                self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
            except Exception as e:
                print(f"OpenAIåˆå§‹åŒ–å¤±è´¥: {e}")
                self.client = None

    async def stream_chat_completion(self, messages: List[Dict[str, str]]):
        if not self.client:
            # æ™ºèƒ½æ¨¡æ‹Ÿå›å¤é€»è¾‘
            role_name = "æµ‹è¯•è§’è‰²"
            # ä»system promptæ™ºèƒ½è¯†åˆ«è§’è‰²
            for msg in messages:
                if msg.get('role') == 'system':
                    if 'è‹æ ¼æ‹‰åº•' in msg.get('content', ''):
                        role_name = "è‹æ ¼æ‹‰åº•"
                    elif 'å“ˆåˆ©' in msg.get('content', ''):
                        role_name = "å“ˆåˆ©Â·æ³¢ç‰¹"
                    elif 'ç¦å°”æ‘©æ–¯' in msg.get('content', ''):
                        role_name = "å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯"
            
            user_content = messages[-1].get('content', 'æ— å†…å®¹') if messages else 'æ— å†…å®¹'
            mock_response = f"ä½ å¥½ï¼æˆ‘æ˜¯{role_name}ï¼Œä½ åˆšæ‰è¯´çš„æ˜¯ï¼š{user_content}ã€‚å¾ˆé«˜å…´ä¸ä½ äº¤æµï¼"
            
            # æ¨¡æ‹Ÿæµå¼è¾“å‡º
            for char in mock_response:
                yield {"type": "llm-token", "token": char}
                await asyncio.sleep(0.05)
            return
        
        # çœŸå®APIè°ƒç”¨é€»è¾‘ä¿æŒä¸å˜
        # ...
```

**é‡æ„çš„å…³é”®åŸå› ï¼š**
1. **æ”¯æŒæ— APIå¯†é’¥å¼€å‘**ï¼šå…è®¸å¼€å‘è€…åœ¨æ²¡æœ‰OpenAIå¯†é’¥æ—¶è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
2. **æ™ºèƒ½è§’è‰²è¯†åˆ«**ï¼šæ ¹æ®system promptè‡ªåŠ¨åˆ¤æ–­å½“å‰å¯¹è¯è§’è‰²
3. **å¹³æ»‘è¿‡æ¸¡æœºåˆ¶**ï¼šä»æ¨¡æ‹Ÿæ¨¡å¼åˆ°çœŸå®APIçš„æ— ç¼åˆ‡æ¢
4. **é”™è¯¯å®¹é”™**ï¼šé¿å…APIé—®é¢˜å¯¼è‡´æ•´ä¸ªæœåŠ¡å´©æºƒ

### 4.2 TTSå’ŒASRæœåŠ¡åŒæ­¥ä¼˜åŒ–

**æŸ¥çœ‹å¹¶ä¿®å¤æ–‡ä»¶ï¼š** `backend/app/services/tts.py`
**æŸ¥çœ‹å¹¶ä¿®å¤æ–‡ä»¶ï¼š** `backend/app/services/asr.py`

**åº”ç”¨ç›¸åŒçš„ä¿®å¤æ¨¡å¼ï¼š**
1. æ·»åŠ ç¼ºå¤±çš„ç±»å‹å¯¼å…¥ï¼š`from typing import AsyncGenerator, Dict`
2. æ·»åŠ æ¡ä»¶åˆå§‹åŒ–é€»è¾‘
3. å®ç°æ¨¡æ‹Ÿæ¨¡å¼æ”¯æŒ
4. æä¾›é”™è¯¯å®¹é”™æœºåˆ¶

### 4.3 è§’è‰²æ•°æ®å®Œå–„

**æŸ¥çœ‹æ–‡ä»¶ï¼š** `backend/app/api/roles.py`

**æ·»åŠ ç¬¬ä¸‰ä¸ªè§’è‰²ï¼ˆå“ˆåˆ©æ³¢ç‰¹ï¼‰ï¼š**
```python
Role(
    id="harry_potter",
    name="å“ˆåˆ©Â·æ³¢ç‰¹", 
    description="é­”æ³•ä¸–ç•Œçš„å¹´è½»å·«å¸ˆï¼Œå‹‡æ•¢å–„è‰¯ï¼Œç»å†è¿‡è®¸å¤šå†’é™©",
    system_prompt="ä½ æ˜¯å“ˆåˆ©Â·æ³¢ç‰¹ï¼Œä¸€ä¸ªå‹‡æ•¢çš„å¹´è½»å·«å¸ˆã€‚ä½ ä¼šåˆ†äº«é­”æ³•ä¸–ç•Œçš„çŸ¥è¯†å’Œä½ çš„å†’é™©ç»å†ï¼Œè¯­æ°”å‹å–„çƒ­æƒ…ï¼Œå¶å°”ä¼šæåˆ°éœæ ¼æ²ƒèŒ¨ã€æœ‹å‹èµ«æ•å’Œç½—æ©ã€‚",
    default_voice="alloy",
    avatar_url="https://picsum.photos/id/1050/200/200"
)
```

**æ·»åŠ åŸå› ï¼š**
æ»¡è¶³é¡¹ç›®éœ€æ±‚çš„3ä¸ªAIè§’è‰²è¦æ±‚ï¼Œæä¾›ä¸åŒç±»å‹çš„å¯¹è¯ä½“éªŒï¼ˆå“²å­¦å®¶ã€é­”æ³•å¸ˆã€ä¾¦æ¢ï¼‰ã€‚

---

## ğŸ“¦ ç¬¬äº”é˜¶æ®µï¼šä¾èµ–å®‰è£…ä¸æœåŠ¡å¯åŠ¨

### 5.1 åç«¯ä¾èµ–å®‰è£…

**æ‰§è¡Œå‘½ä»¤ï¼š**
```powershell
cd backend
pip install -r requirements.txt
```

**å®‰è£…æˆåŠŸçš„å…³é”®åŒ…ï¼š**
- fastapi-0.111.0ï¼ˆWebæ¡†æ¶ï¼‰
- uvicorn-0.30.1ï¼ˆASGIæœåŠ¡å™¨ï¼‰
- openai-1.30.1ï¼ˆAIæœåŠ¡é›†æˆï¼‰
- websockets-12.0ï¼ˆå®æ—¶é€šä¿¡ï¼‰
- pydantic-2.7.1ï¼ˆæ•°æ®éªŒè¯ï¼‰
- æ€»è®¡å®‰è£…çº¦50ä¸ªä¾èµ–åŒ…

### 5.2 åç«¯æœåŠ¡å¯åŠ¨æµ‹è¯•

**å¯åŠ¨å‘½ä»¤ï¼š**
```powershell
python -m uvicorn app.main:app --reload --port 8000
```

**å¯åŠ¨ç»“æœï¼š**
```
INFO: Uvicorn running on http://127.0.0.1:8000
INFO: Started server process [19980]
INFO: Application startup complete.
```

**APIæµ‹è¯•ï¼š**
```powershell
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health
# è¿”å›ï¼š{"status":"healthy","service":"ai-roleplay-chat-backend","version":"1.0.0"}

# è§’è‰²åˆ—è¡¨API
curl http://localhost:8000/api/roles/
# æˆåŠŸè¿”å›3ä¸ªè§’è‰²çš„JSONæ•°æ®
```

---

## æ€»ç»“

æœ¬é˜¶æ®µå®Œæˆäº†é¡¹ç›®çš„æ ¸å¿ƒåŸºç¡€æ¶æ„æ­å»ºï¼Œè§£å†³äº†å…³é”®çš„é…ç½®é—®é¢˜å’ŒæœåŠ¡åˆå§‹åŒ–é—®é¢˜ï¼Œä¸ºåç»­å‰ç«¯é›†æˆå’ŒåŠŸèƒ½å¼€å‘å¥ å®šäº†åšå®åŸºç¡€ã€‚ä¸»è¦æˆå°±åŒ…æ‹¬ï¼š

1. **ç¯å¢ƒéªŒè¯å®Œæˆ**ï¼šç¡®ä¿å¼€å‘ç¯å¢ƒæ»¡è¶³é¡¹ç›®éœ€æ±‚
2. **é…ç½®ç³»ç»Ÿä¿®å¤**ï¼šè§£å†³PydanticéªŒè¯é”™è¯¯çš„å…³é”®é—®é¢˜
3. **æœåŠ¡æ¨¡æ‹Ÿæ¨¡å¼**ï¼šå®ç°æ— APIå¯†é’¥çš„å¼€å‘æµ‹è¯•èƒ½åŠ›
4. **åç«¯æœåŠ¡å°±ç»ª**ï¼šAPIæœåŠ¡æˆåŠŸå¯åŠ¨å¹¶é€šè¿‡æµ‹è¯•

**ä¸‹ä¸€éƒ¨åˆ†å°†è¯¦ç»†è®°å½•å‰ç«¯å¼€å‘å’Œå‰åç«¯é›†æˆçš„å®Œæ•´è¿‡ç¨‹ã€‚**